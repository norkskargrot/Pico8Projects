pico-8 cartridge // http://www.pico-8.com
version 32
__lua__
--non-terrain objects
p={}
p2={}

acc=0.04
drag=0.8

function _init()
	objs={}
	initplayer(p,0)
	initplayer(p2,1)
	initenemy(0)
end

function initplayer(p,n)
	p.x=1.5
	p.y=1.5
	p.w=0.1
	p.h=0.1
	p.dx=0
	p.dy=0
	p.walking=false
	p.update=playerupdate
	p.draw=playerdraw
	p.playernumber=n
	
	add(objs,p)
end

function initenemy()
	local e={}
	e.x=4
	e.y=2
	e.w=0.1
	e.h=0.1
	e.dx=0
	e.dy=0
	e.walking=false
	e.update=enemyupdate
	e.draw=playerdraw
	add(objs,e)
end
-->8
--update
function _update60()
	for k,v in pairs(objs) do
		v.update(v)
	end
end

function playerupdate(p)
	inpt=getinput(p.playernumber)
	
	p.walking=false
	p.aiming=false
	
	if inpt.i1 then
		p.aiming=true
	elseif inpt.i2 then
	
	else
		--move the player
		if abs(inpt.y)==0 then
			p.dx+=inpt.x*acc*cos(0.125)
		elseif abs(inpt.x)==0 then
			p.dy+=inpt.y*acc*cos(0.125)
		else
			p.dx+=inpt.x*acc
			p.dy+=inpt.y*acc
		end
	end
	--friction if not moving
	p.dx*=drag
	p.dy*=drag
	
	--map collisions
	if solidarea(p.x+p.dx,p.y,p.w,p.h) then
		p.dx=0
	else
		p.x+=p.dx
	end
	if solidarea(p.x,p.y+p.dy,p.w,p.h) then
		p.dy=0
	else
		p.y+=p.dy
	end
	
	--walking, used for animation
	if abs(p.dy)+abs(p.dx)>0.1 then
	 p.walking=true
	end
end

function getinput(n)
	local inpt={}
	inpt.x=0
	inpt.y=0
	if btn(0,n) then inpt.x-=1 inpt.y+=1 end
	if btn(1,n) then inpt.x+=1 inpt.y-=1 end
	if btn(2,n) then inpt.y-=1 inpt.x-=1 end
	if btn(3,n) then inpt.y+=1 inpt.x+=1	end
	
	if btn(4,n) then inpt.i1=true end
	if btn(5,n) then inpt.i2=true end
	
	return inpt
end

function enemyupdate(obj)
	obj.dx+=(p.x-obj.x)/100
	obj.dy+=(p.y-obj.y)/100
	obj.dx*=0.9
	obj.dy*=0.9
	obj.x+=obj.dx
	obj.y+=obj.dy
end

function solidarea(x,y,w,h)
	return 
		solid(x-w,y-h) or
		solid(x+w,y-h) or
		solid(x-w,y+h) or
		solid(x+w,y+h)
end

function solid(x,y)
	local tile=mget(x,y)
	return fget(tile,0)
end
-->8
--draw
function _draw()
	cls(3)
	local cam=getcampos()
	local sorted=sortobjs(cam)
	drawiso(sorted)
	--drawcart()
	minimap()
	drawlogs()
end

function getcampos()
	local cam={}
	cam.x,cam.y=carttoiso(p.x*4,p.y*4)
	return cam
end

function sortobjs(cam)
local sorted={}
	for j=-1,33 do
		sorted[j]={}
	end
	for k,v in pairs(objs) do
		local x,y=carttoiso(v.x*4,v.y*4)
		v.ssx=64+x-cam.x
		v.ssy=64+y-cam.y
		local row=flr(v.ssy/2-1)
		add(sorted[row],v)
	end
	return sorted
end

function drawiso(sorted)
	--0-32 onscreen,+edges
	for j=-3,64 do
		--0-8 onscreen, +edges
		for i=-1,16 do
			local shft=(j%2)/2
			cx=j/2+i-shft
			cy=j/2-i+shft
			--get the map value
			local mapval=mget(cx-23+p.x,cy-8+p.y)
			--draw the tile
			if not(mapval==0 or mapval==4) then
				drawtile(mapval,i,j)
			end
		end
		for k,v in pairs(sorted[j]) do
			v.draw(17,v)
		end
	end
end

function drawtile(n,i,j)
	local x=(i-(j%2)/2)*8
	local y=j*2
	local px,py=carttoiso((p.x%1)*4,(p.y%1)*4)
	local h=fget(n)
	spr(n+4,x-px,y-py,1,1)
end

function minimap()
	for i=0,15 do
		for j=0,15 do
			local mapval=mget(i+p.x-8,j+p.y-8)
			local col=3
			if mapval==2 then
				col=5
			elseif mapval==16 then
				col=8
			elseif mapval==3 then
				col=11
			end
			pset(i+109,j+109,col)
		end
	end
	pset(117,117,15)
	rect(108,108,125,125,1)
end

function carttoiso(x,y)
	local isox=x-y
	local isoy=(x+y)/2
	return isox,isoy
end

function isotocart(x,y)
	local cartx=(2*y+x)/2
	local carty=(2*y-x)/2
	return cartx,carty
end

function drawcart()
	map(0,0,0,0,16,16)
	drwcha(17,p)
	aimcirc(p)
end

function playerdraw(num,obj)
	local mod=time()*2%2
	spr(num+mod,obj.ssx-4,obj.ssy-8)
end

function aimcirc(p)
	if p.aiming then
		line(p.x,p.y,p.x+p.inpt.x*10,p.y+p.inpt.y*10)
	end
end
-->8
--utility
function drawlogs()
	print("cpu use=",0,0,7)
	print(stat(1),32,0,7)
	
	print("fps=",0,6,7)
	print(stat(7),16,6,7)
	
	print("memory=",0,12,7)
	print(stat(0),28,12,7)
end
__gfx__
00000000111001116555655500033000333333330008800000066000000110000000000000848000000000000000000000000000000000000000000000000000
00000000100440016555655500033000333333330088880006666660001b10000000000008484800000000000000000000000000000000000000000000000000
007007000b3ff3b066666666003333003333333308888880666666660013b1000000000004848880000000000000000000000000000000000000000000000000
0007700003533530556555650033330033333333888888885666666d013bb1000000000048484888000000000000000000000000000000000000000000000000
000770000f5555f055655565033333303333333388888888d5566d6601b3bb100003300004848880000000000000000000000000000000000000000000000000
00700700103333016666666603333330333333330ffffff05dddd66d1b3b3b10033333300d584ff0000000000000000000000000000000000000000000000000
00000000103003016555655533333333333333330ff44ff00d5d6dd001b3b3b10333333005d5f4f0000000000000000000000000000000000000000000000000
00000000100110016555655500044000333333330ff44ff0000560000015411000033000000df000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000f00000004000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000020000000f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000200000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0000010100010001000200010100000001000001000000000000000101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0202020202020202020202020202020204040404040404040404040404040404040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0204040404040404040402040404040204040404030404040404040404040404040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0204040404040404040402040404040204040404040404040404040404040404030404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0204040402020202020202040404040204040404040202020202020404040404040402020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0204040404040404040404030404040404040404040404040404040404040404040404020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0204040404040404040404040404040204040404040404040404040404040404020404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0204040403040404040404050404040204040404040404040404040404040404020404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0204040204040405040404020202020204040304040202040404040204040404020404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0204040204040404040404020404040404040404020204040404040204030404020404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0204040204040404020404020404040204040404040202040404040204040404020404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0204020204040304040404020404040204040404040402040404040404040404020404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0204040404040404040402020404040202020202020202040404040404040404040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0204040404040405040402040404040204040404040404040404020202040404040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0204040202020404040404040403040204040404040404040404040404040404040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0204040404040404040405040404040204040304040404040404040404040404040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020204040404020202020204040404020202020202020404040404040304040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040404040404040404040404040404040404040404040404020202020404040304040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040404040404040404040404040404040404040404040404040404020404040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040404040202040404040404020204040402020404040404040404020404040404040000000000000000000097980000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
04040404040202040404040404040204040404040404040304030404040404040404040400000000000000000000a7a80000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0403040404020404040404040404040404040404030404040404040304040404040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040202020404040404040403040204040404040404040404040404040404040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040202040404040202040404040204040304030404040304040404040404040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040202040404040204040404020204040404040404040404040202020404040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040402040404040404040404040404040403040304040202020204020204040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0403040402040404040404040404040404040404040404020204020404040204040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040402040404020204040404040404040404040402020404020404040204040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040402040404040204040402020202040304040404030404040404040204040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020402040404040404040403040404040404040404040404040404040202040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404020202020404040404040404040404040404040304040404030404040404040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040404040404040404040404040404040404040404040304040404040404040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
000100000857008500085000000012300157001570014700155002450015700157001570015700167001670016700167001670016700167001670016700167001670016700167001650016500000000000000000
001000003905000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
