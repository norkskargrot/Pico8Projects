pico-8 cartridge // http://www.pico-8.com
version 41
__lua__
r,y=1.999,0
dr=0.05
centerx=32
mapcircum=10
layers={
	{rad=16,thickness=4,mask=0b00000011},
	{rad=22,thickness=6,mask=0b00000001},
}
cyloffsetarrs={}

nearzero=0x.01

function _init()
 poke(0x5f2c, 3)
	for k,v in pairs(layers) do
		v.arrouter=calcoffsets(v.rad)
		v.arrinner=calcoffsets(v.rad-v.thickness)
	end
end

function calcoffsets(rad)
	local arr={}
	cls()
	for x=-rad,rad do
		local y=sqrt(rad*rad-x*x) 
		local a=atan2(x,y+0x01)
		arr[x]=a-0.75
	end
	return arr
end

function _update60()
if (btn(0)) r+=dr
if (btn(1)) r-=dr
if (btn(2)) y-=1
if (btn(3)) y+=1
r=r%mapcircum
end

function _draw()
	cls(12)
	camera(0,y)
	--rectfill(68-rad1,0,60+rad1,127,1)
	
	drawlayer(layers[2],true)
	drawlayer(layers[1],true)
	drawlayer(layers[1],false)
	drawlayer(layers[2],false)
	
	print(stat(1),1,1,7)
	print(r,1,9,7)
end

function drawlayer(l,backface)
	pal(13,5)
	pal(5,1)
	pal(6,1)
	drawwalls(l,backface)
	pal()
	if backface then
		r=r+mapcircum/2
		pal(5,0)
		pal(13,1)
		pal(6,5)
		drawcyl(l.rad-l.thickness,l.arrinner,l.mask,true)
		r=r-mapcircum/2
		pal()
	else
		drawcyl(l.rad,l.arrouter,l.mask)
	end
end

function drawwalls(l,backface)
	for i=1,mapcircum do
		-- Draw the walls from back to front by ping-pong through i
		local o=flr(i/2)*(2*(i%2)-1)
		local a=((o-r%1)/mapcircum)%1-nearzero
		local y=cos(a)
		if (backface) y=-y
		if y<0 then
			local x1=flr(sin(a)*(l.rad-l.thickness))
			local x2=sin(a)*(l.rad)
			--if (backface) line(centerx+x1+1,0,centerx+x1+1,127,8)
			if (x1 > x2) x1,x2=x2,x1
			x2+=1
			for j=x1,x2 do
				local p=(j-x1)/(x2-x1)
				local mx=o+flr(r)+mapcircum/2+p
				if (x1<0) mx-=1
				mx=mx%mapcircum
				mapcol(mx,0,j+centerx,0,l.mask)
			end
		end
	end
	--if (backface) drawSideWalls(l)
end

function drawSideWalls(l)
	for i=0,l.thickness do
		local p=i/l.thickness
		local mx1=(flr(r+mapcircum/4)+p)%mapcircum
		local mx2=(flr(r-mapcircum/4)+p-nearzero)%mapcircum
		local x=l.rad+i-l.thickness
		mapcol(mx1,0,centerx+x,0,l.mask)
		mapcol(mx2,0,centerx-x,0,l.mask)
	end
end

function drawcyl(rad,arr,mask,backface)
	for i=-rad,rad do
		local x=centerx+i
		local mx=arr[i]*mapcircum
		if(backface) mx=-mx
		local mx=(mx+r)%mapcircum
		mapcol(mx,0,x,0,mask)
		--pset(64+i,64+arr[i]*100,8)
	end
end

function mapcol(mx,my,sx,sy,mask)
	clip(sx,sy,1,128)
	local dx=flr((mx%1)*8)
	map(mx,my,sx-dx,sy,1,16,mask)
	clip()
end
__gfx__
00000000ddddddd5666666650000000000000000ddddddd511111111888888880000000000000000000000000000000000000000000000000000000000000000
00000000ddddddd5ddddddd50000000000000000ddddddd511111111888888880000000000000000000000000000000000000000000000000000000000000000
00700700ddddddd5ddddddd50000000000000000ddddddd5ddd1dddd888888880000000000000000000000000000000000000000000000000000000000000000
00077000555555555555555500000000000000005555555555555555888888880000000000000000000000000000000000000000000000000000000000000000
00077000ddd5ddddddd5ddddddd5dddd66656666ddd5ddddddd5dddd888888880000000000000000000000000000000000000000000000000000000000000000
00700700ddd5ddddddd5ddddddd5ddddddd5ddddddd5ddddddd5dddd888888880000000000000000000000000000000000000000000000000000000000000000
00000000ddd5ddddddd5ddddddd5ddddddd5ddddddd5ddddddd5dddd888888880000000000000000000000000000000000000000000000000000000000000000
00000000555555555555555555555555555555555555555555555555888888880000000000000000000000000000000000000000000000000000000000000000
ddd5ddd5000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
dd515dd5000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
d50105d5000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
5001005d000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
5001005d000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
5001005d000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
5111115d000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
50010055000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
50010055000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
50010055000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
56666655000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
55555555000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
ddd5dddd000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
ddd5dddd000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
ddd5dddd000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
55555555000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0002010201010202000000000000000002000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0002000200020002000200020002000200000200020002000200020002000200020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0205020502050205020502050205020500020502050205020502050205020502050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0606060606000000060606060606060600060606060606060606060606060606060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101100100000000010101000001010000010110010101010101011001010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101200000030301010100000000000100010120010101010101012004020201010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202010001010101010000000001010100020201010101010202020205050601010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0606010101010101000000000301010100060601010101010606060606060101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101100101000000000000000101020100010110010101010101011001010102010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101200101010103030000010101060100010120010101010101012001010106010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0001020202010101010101010202020200010102020201010101010101020202020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000006010101010101010606060600010106060601010101010101060606060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0103000000010101010101010101010100010101010101010101010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010103010101010101010101010100010101010101010101010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100010101010101010101010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
