pico-8 cartridge // http://www.pico-8.com
version 34
__lua__
cls()

x=64
y=64
z=16
r=0

cols={6,13,5,1,0}

function _update()
	if (btn(0)) r-=0.01
	if (btn(1)) r+=0.01
	if (btn(2)) x+=sin(r) y+=cos(r)
	if (btn(3)) x-=sin(r) y-=cos(r)
end

function _draw()
	--cls()
	draw3d()
	draw2d()
end

function draw2d()
	map(0,0,0,0,16,16)
	line(x,y,x+sin(r)*5,y+cos(r)*5,12)
	pset(x,y,8)
end

function draw3d()
	local fov=0.15
	local x,y,z,r=x,y,z,r
	--[[
	for i=0,127 do
		local a=(i-64)*fov/127
		local d=raycast(x,y,z,r+a,0)/100
		local c=cols[ceil(d*6)]
		local h=(5/d)
		line(i,64-h,i,64+h,c)
	end
	]]--
	for i=0,150 do
		local px,py=rnd(127),rnd(127)
		local ah=(px-64)*fov/127
		local av=(py-64)*0.01/127
		local d=raycast(x,y,z,r+ah,av)/100
		local c=cols[ceil(d*5)]
		pset(px,py,c)
	end
end

function raycast(ox,oy,oz,dirh,dirv)
	local dx,dy=sin(dirh),cos(dirh)
	local dz=sin(dirv)
	printh(dz)
	local dd=sqrt(dx*dx+dy*dy+dz*dz)
	local hit,d=false,0
	local fx,fy,fz=ox,oy,oz
	while hit==false do
		fx+=dx
		fy+=dy
		fz+=dz
		d+=dd
		if issolid(fx,fy,fz) or d>100 then
			hit=true
		end
	end
	--line(ox,oy,fx,fy,6)
	return d
end

function issolid(x,y,z)
	return x<0 or x>120
					or y<0 or y>120
					or z<0 or z>32
	    or fget(mget(x/8+flr(z*2),y/8),0)
end
__gfx__
00000000070707070000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000707070700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700070707070000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000707070700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000070707070000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700707070700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000070707070000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000707070700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000001000000000101000000000000000000010000000001010000000000000000000100000000010100000000000000000001000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000001000000000101000000000000000000010000000001010000000000000000000100000000010100000000000000000001000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000001000000000101000000000000000000010000000001010000000000000000000100000000010100000000000000000001000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000001000000000101000000000000000000010000000001010000000000000000000100000000010100000000000000000001000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000001000000000101000000000000000000010000000001010000000000000000000100000000010100000000000000000001000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000001010101000101000000000000000000010101010001010000000000000000000101010100010100000000000000000001010101000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000101010100000000000000000101000000000000000000000000000001010000010101010000000000000000010100000101010100000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000100000100000000000000000101000000000000000000000000000001010000010000010000000000000000010100000100000100000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000100000000000000000101000000000000000000000000000001010000000000010000000000000000010100000000000100000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000101010100000000000000000101000000000000000000000000000001010000010101010000000000000000010100000101010100000000000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000001010101000101000000000000000000010101010001010000000000000000000101010100010100000000000000000001010101000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000001000000000101000000000000000000010000000001010000000000000000000100000000010100000000000000000001000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000001000000000101000000000000000000010000000001010000000000000000000100000000010100000000000000000001000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0100000000000000000001000000000101000000000000000000010000000001010000000000000000000100000000010100000000000000000001000000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
