pico-8 cartridge // http://www.pico-8.com
version 32
__lua__
p={}
s={}

function _init()
	initrope()
end

function initrope()
	local l,n=2,40
	for i=0,n do
		local point={}
		point.ox=64+i*l
		point.oy=64
		point.x=64+i*l
		point.y=64
		point.w=0.1
		if(i==0)point.lock=true
		add(p,point)
	end
	for i=1,n do
		local stick={}
		stick.a=i
		stick.b=i+1
		stick.l=l
		add(s,stick)
	end
end

function _update()
	cls()
	map(0,0,0,0,16,16)
	if(btn(0)) p[1].x-=2
	if(btn(1)) p[1].x+=2
	if(btn(2)) p[1].y-=2
	if(btn(3)) p[1].y+=2
	
	for k,v in pairs(p) do
		if(not v.lock) then
			local oldx=v.x
			local oldy=v.y
			local nx,ny=2*v.x-v.ox,2*v.y-v.oy+v.w

			v.x,v.y=collide(v.x,v.y,nx,ny)
			v.ox=oldx
			v.oy=oldy
		end
	end
	for i=0,10 do
		for k,v in pairs(s) do
			local a,b=p[v.a],p[v.b]
			local c=vmul(vadd(a,b),0.5)
			local d=norm(vsub(a,b))
			v.c,v.d=c,d
			if not a.lock then
				local nx=c.x+d.x*v.l/2
				local ny=c.y+d.y*v.l/2
				a.x,a.y=collide(a.x,a.y,nx,ny)
			end
			if not b.lock then
				local nx=c.x-d.x*v.l/2
				local ny=c.y-d.y*v.l/2
				b.x,b.y=collide(b.x,b.y,nx,ny)
			end
		end
	end
end

function collide(cx,cy,gx,gy)
	local v=max(abs(gx-cx),abs(gy-cy))
	for i=v,0,-1 do
		local t=i/v
		local x=cx+(gx-cx)*t
		local y=cy+(gy-cy)*t
		if (not issolid(x,y)) return x,y
		if (not issolid(x-sgn(gx-cx),y)) return x-sgn(gx-cx),y
		if (not issolid(x,y-sgn(gy-cy))) return x,y-sgn(gy-cy)
	end
	return cx,cy
end

function _draw()
	cls()
	map(0,0,0,0,16,16)
	for k,v in pairs(s) do
		local a=p[v.a]
		local b=p[v.b]
		line(a.x,a.y,b.x,b.y,9)
	end
	for k,v in pairs(p) do
		local c=10
		if(v.lock) c=8
		pset(v.x,v.y,c)
	end
	printh(stat(1))
end

function norm(v)
	local l=sqrt(v.x*v.x+v.y*v.y)
	return {x=v.x/l,y=v.y/l}
end

function vadd(a,b)
	return {x=a.x+b.x,y=a.y+b.y}
end

function vsub(a,b)
	return {x=a.x-b.x,y=a.y-b.y}
end

function vmul(a,b)
	return {x=a.x*b,y=a.y*b}
end

function issolid(x,y)
	local m=mget(x/8,y/8)
	return pget(x,y)==5
	--return fget(m,0)
end
__gfx__
00000000000000000055550000000555555000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000555555000055555555550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700000000005555555500555555555555000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000000000005555555505555555555555500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000000000005555555505555555555555500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700000000005555555555555555555555550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000555555055555555555555550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000055550055555555555555550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000055555555555555550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000055555555555555550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000055555555555555550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000005555555555555500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000005555555555555500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000555555555555000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000055555555550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000555555000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000003040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0002000013140000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000200030400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000131400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000020000030400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000131400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
