pico-8 cartridge // http://www.pico-8.com
version 32
__lua__
p={x=64,y=64}
z,h={},{}

hcols={2,3,11}
bcols={14,12}

function _init()
	poke(0x5f36,16)
	--poke(0x5f2c,3)
	memset(0x8000,0,0x4000)
	
	drawphysmap()
	
	for i=0,10 do
		local x,y=rnd(128),rnd(128)
		if pget(x,y)==0 then
			local hcol=hcols[ceil(rnd(#hcols))]
			local bcol=bcols[ceil(rnd(#bcols))]
			add(z,{x=x,y=y,hcol=hcol,bcol=bcol})
		end
	end
	for i=0,100 do
		local x,y=rnd(128),rnd(128)
		if pget(x,y)==0 then
			local hcol=hcols[ceil(rnd(#hcols))]
			local bcol=bcols[ceil(rnd(#bcols))]
			add(h,{x=x,y=y,hcol=hcol,bcol=bcol})
		end
	end
	restartpathing()
end

function _update()
	pathiterate()
	
	drawphysmap()
	
	--move player
	local dx,dy,spd=0,0,0.3
	if (btn(0)) dx-=spd
	if (btn(1)) dx+=spd
	if (btn(2)) dy-=spd
	if (btn(3)) dy+=spd
	if (abs(dx)>0 and abs(dy)>0) dx,dy=dx*0.707,dy*0.707
	if pget(p.x+dx,p.y+dy)!=5 then
		p.x,p.y=p.x+dx,p.y+dy
	elseif pget(p.x,p.y+dy)!=5 then
		p.x,p.y=p.x,p.y+dy
	elseif pget(p.x+dx,p.y)!=5 then
		p.x,p.y=p.x+dx,p.y
	end
	pset(p.x,p.y,9)
	
	--zombies
	for k,v in pairs(z) do
		pset(v.x,v.y,8)
	end
	for k,v in pairs(z) do
		if abs(p.x-v.x)<=64 and abs(p.x-v.x)<=64 and rnd(1)>0.5 then
			local dir=getdir(v.x,v.y)-1
			if dir!=-1 then
				local dx=-0.6*(dir%3-1)
				local dy=-0.6*(flr(dir/3)-1)
				local nx,ny=v.x+dx,v.y+dy
				if (flr(v.x)==flr(nx) and flr(v.y)==flr(ny))
				or pget(nx,ny)==0 then
						v.x,v.y=nx,ny
				end
			end
		end
	end
	
	--humans
	for k,v in pairs(h) do
		if pget(v.x,v.y)==8 then
			del(h,v)
			add(z,v)
		end
	end
	
	printh(stat(1))
end

function _draw()
	--cls()
	--memcpy(0x6000,bpadr,0x2000)
	--drawcenter(0x6000)
	
	camera(p.x-64,p.y-64)
	--clip(0,0,64,64)

	--map bottom layer
	map(0,0,0,0,128,128)
	
	--humans
	for k,v in pairs(h) do
		pset(v.x,v.y,9)
	end
	for k,v in pairs(h) do
		pset(v.x,v.y-1,15)
	end
	
	--zombies
	for k,v in pairs(z) do
		pset(v.x,v.y,v.bcol)
	end
	for k,v in pairs(z) do
		pset(v.x,v.y-1,v.hcol)
	end
	
	--player
	pset(p.x,p.y,8)
	pset(p.x,p.y-1,15)
	
	--map top layer
	for i=0,15 do
		palt(i,true)
	end
	pal(5,6)
	palt(5,false)
	map(0,0,0,-1,128,128)
	resetpal()
	
	camera()
end

function drawphysmap()
	cls()
	camera(p.x-64,p.y-64)
	mapcollidepal()
	map(0,0,0,0,128,128)
	pal()
end

function mapcollidepal()
	--pallete
	for i=0,15 do
		pal(i,0)
	end
	pal(5,5)
end

function resetpal()
	pal()
	pal(11,131,1)
	pal(2,139,1)
	pal(12,128,1)
	pal(14,133,1)
end

function drawcenter(adr)
	dadr=0x6000
	sadr=adr+64*32+16
	for i=0,63 do
		memcpy(dadr,sadr,32)
		dadr+=64
		sadr+=64
	end
end
-->8
--pathing
cpi=0
cpadr,bpadr=0x8000,0xa000
pathoff={{x=0,y=0},{x=0,y=0}}

function pathiterate()
	local pointsperframe=650
	local maxdist=200
	local i=0
	while true do
		local remaining={}
		--iterate through active
		for k,v in pairs(active) do
			if i<pointsperframe then
				updatespaces(v.x,v.y)
				i+=1
			else
				add(remaining,v)
			end
		end
		if (i>=pointsperframe) then
			active=remaining
			return
		end
		pathdist+=1
		active=newlist
		newlist={}
		if (pathdist>maxdist) then
			restartpathing()
		end
	end
end

function restartpathing()
	cpi=1-cpi
	cpadr=0x8000+cpi*0x2000
	bpadr=0x8000+(1-cpi)*0x2000
	local off=pathoff[cpi+1]
	off.x,off.y=64-flr(p.x),64-flr(p.y)
	cls()
	mapcollidepal()
	map(0,0,off.x,off.y,16,16)
	pal()
	memcpy(cpadr,0x6000,0x2000)
	active={{x=64,y=64}}
	for k,v in pairs(h) do
		add(active,{x=v.x+off.x,y=v.y+off.y})
	end
	newlist={}
	pathdist=0
end

function updatespaces(x,y)
	if rnd(1)>0.5 then
		updatespace(x,y-1,2)
		updatespace(x-1,y,4)
		updatespace(x+1,y,6)
		updatespace(x,y+1,8)
	else
		updatespace(x,y+1,8)
		updatespace(x+1,y,6)
		updatespace(x-1,y,4)
		updatespace(x,y-1,2)
	end
end

function updatespace(x,y,col)
	if x<0
	or y<0
	or x>128
	or y>128
	or cpget(cpadr,x,y)!=0 then 
		return
	end
	add(newlist,{x=x,y=y})
	x,y=x&0xff,y&0xff
	local addr=cpadr+(y<<6)+(x>>1)
	local shft=(x%2<<2)
	local cur=@(addr)&(0xf0>>shft)
	poke(addr,cur|col<<shft)
end

function getdir(x,y)
	local off=pathoff[2-cpi]
	x,y=x+off.x,y+off.y
	if (x<0 or y<0 or x>127 or y>127) return 0
	return cpget(bpadr,x,y)
end

function cpget(ad,x,y)
	x,y=x&0xff,y&0xff
	return 0xf&@(ad+(y<<6)+(x>>1))>>(x%2<<2)
end

__gfx__
00000000d11111dd55555555ddddddddddddddddd11111ddddddddddd11111dd0000000000000000000000000000000000000000000000000000000000000000
00000000d11d11dd544444455555555dddddddddd11d11ddddddddddd11d11dd0000000000000000000000000000000000000000000000000000000000000000
00700700d11d11dd544444444444545dddddddddd11d111111111111111d11dd0000000000000000000000000000000000000000000000000000000000000000
00077000d11d11dd444444454444544dddddddddd111111111111111111111dd0000000000000000000000000000000000000000000000000000000000000000
00077000d11111dd555554454444545dddddddddd11111dd1ddd1dddd11111dd0000000000000000000000000000000000000000000000000000000000000000
00700700d11d11dd544444454444445dddddddddd111111111111111111111dd0000000000000000000000000000000000000000000000000000000000000000
00000000d11d11dd544444455545555dddddddddd11d111111111111111d11dd0000000000000000000000000000000000000000000000000000000000000000
00000000d11d11dd55555555ddddddddddddddddd11d11ddddddddddd11d11dd0000000000000000000000000000000000000000000000000000000000000000
__map__
0203040104040402030401040404040404040404040404040404040404040404040404040404040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040102030404040401040404040404040404040404040404040404040404040404040404040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404020506060606060607040404040404040404040404040404040404040404040404040404040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0203040102040203040401040404040404040404040404040404040404040404040404040404040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0204040103040404020301040404040404040404040404040404040404040404040404040404040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040102030404040401040302040404040404040404040404040404040404040404040404040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0606060704040402030201040404040404040404040404040404040404040404040404040404040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040104020304040401040204040404040404040404040404040404040404040404040404040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0402040104040404040401040404040404040404040404040404040404040404040404040404040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040104040203030201040402040404040404040404040404040404040404040404040404040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0402040102030404040401040404040404040404040404040404040404040404040404040404040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040104040404040401040404040404040404040404040404040404040404040404040404040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040104040404040401040404040404040404040404040404040404040404040404040404040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040404040404040404040404040404040404040404040404040404040404040404040404040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040404040404040404040404040404040404040404040404040404040404040404040404040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040404040404040404040404040404040404040404040404040404040404040404040404040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040404040404040404040404040404040404040404040404040404040404040404040404040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040404040404040404040404040404040404040404040404040404040404040404040404040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040404040404040404040404040404040404040404040404040404040404040404040404040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040404040404040404040404040404040404040404040404040404040404040404040404040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040404040404040404040404040404040404040404040404040404040404040404040404040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040404040404040404040404040404040404040404040404040404040404040404040404040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040404040404040404040404040404040404040404040404040404040404040404040404040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040404040404040404040404040404040404040404040404040404040404040404040404040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040404040404040404040404040404040404040404040404040404040404040404040404040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040404040404040404040404040404040404040404040404040404040404040404040404040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040404040404040404040404040404040404040404040404040404040404040404040404040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040404040404040404040404040404040404040404040404040404040404040404040404040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040404040404040404040404040404040404040404040404040404040404040404040404040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040404040404040404040404040404040404040404040404040404040404040404040404040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0404040404040404040404040404040404040404040404040404040404040404040404040404040404040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
